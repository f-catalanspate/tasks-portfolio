-- Step 1: Calculate Potential Demand per Record
WITH PotentialDemandPerRecord AS (
    SELECT
        `City`,
        `Date`,
        `Hour`,
        `Completed orders`,
        `Shrinkage %`,
        `Completed orders` / (1 - 0.0025 * `Shrinkage %`) AS `Potential Demand`
    FROM
        demand_data
),

-- Step 2: Aggregate Potential Demand per City, Week, and Hour
AggregatedDemand AS (
    SELECT
        `City`,
        YEARWEEK(`Date`, 1) AS `YearWeek`,
        `Hour`,
        SUM(`Potential Demand`) AS `Total Potential Demand`
    FROM
        PotentialDemandPerRecord
    GROUP BY
        `City`,
        `YearWeek`,
        `Hour`
),

-- Step 3: Rank Hours Based on Total Potential Demand
RankedDemand AS (
    SELECT
        `City`,
        `YearWeek`,
        `Hour`,
        `Total Potential Demand`,
        RANK() OVER (PARTITION BY `City`, `YearWeek` ORDER BY `Total Potential Demand` DESC) AS `Demand Rank`
    FROM
        AggregatedDemand
)

-- Step 4: Select Top 5 Peak Hours per City and Week
SELECT
    `City`,
    `YearWeek`,
    `Hour`,
    `Total Potential Demand`
FROM
    RankedDemand
WHERE
    `Demand Rank` <= 5
ORDER BY 4 DESC
